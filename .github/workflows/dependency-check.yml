# ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ¯é€±ä¾å­˜é–¢ä¿‚ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ›´æ–°ãŒå¿…è¦ãªå ´åˆã¯é€šçŸ¥ã—ã¾ã™

name: Dependency Check

on:
  # æ¯é€±ç«æ›œæ—¥ã®åˆå‰10æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 10 * * 2'
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
  # main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚‚å®Ÿè¡Œ
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for outdated dependencies
        id: outdated
        run: |
          echo "## ğŸ“¦ Dependency Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å¤ã„ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
          echo "### Outdated Dependencies" >> $GITHUB_STEP_SUMMARY
          if npm outdated > outdated.txt 2>&1; then
            if [ -s outdated.txt ]; then
              echo "```" >> $GITHUB_STEP_SUMMARY
              cat outdated.txt >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
              echo "has_outdated=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
              echo "has_outdated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "```" >> $GITHUB_STEP_SUMMARY
            cat outdated.txt >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            echo "has_outdated=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for major updates
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Major Version Updates Available" >> $GITHUB_STEP_SUMMARY
          
          # npm-check-updatesã‚’ä½¿ç”¨ã—ã¦ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          npx -y npm-check-updates > major-updates.txt 2>&1 || true
          
          if grep -q "All dependencies match the latest package versions" major-updates.txt; then
            echo "âœ… No major updates available" >> $GITHUB_STEP_SUMMARY
          else
            echo "```" >> $GITHUB_STEP_SUMMARY
            cat major-updates.txt >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Security audit
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œ
          if npm audit --audit-level=moderate > audit.txt 2>&1; then
            echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            cat audit.txt >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create issue if updates needed
        if: steps.outdated.outputs.has_outdated == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ - ${date}`;
            
            // æ—¢å­˜ã®issueã‚’ãƒã‚§ãƒƒã‚¯
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: 'ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚GitHub Actionsã®Summaryã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
                labels: ['dependencies', 'maintenance']
              });
            }