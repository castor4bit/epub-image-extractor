name: Release (Code Signed)

on:
  # 無効化: タグpushでのトリガーを無効化
  # push:
  #   tags:
  #     - 'v*'
  workflow_dispatch:  # 手動実行のみ

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # macOS証明書のセットアップ
    - name: Import Code Signing Certificate
      if: env.MACOS_CERTIFICATE
      env:
        MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
        MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
      run: |
        echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
        security create-keychain -p actions build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p actions build.keychain
        security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k actions build.keychain
    
    - name: Build and sign
      env:
        CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
        CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        npm run dist:mac-x64
        npm run dist:mac-arm64
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mac-builds
        path: release/*.dmg

  build-win:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build and sign
      env:
        CSC_LINK: ${{ secrets.WINDOWS_CERTIFICATE }}
        CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PWD }}
      run: npm run dist:win
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: win-builds
        path: release/*.exe

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-artifacts/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}