name: Release (Code Signed)

on:
  # 無効化: タグpushでのトリガーを無効化
  # push:
  #   tags:
  #     - 'v*'
  workflow_dispatch:  # 手動実行のみ

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Setup Node.js
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: 24.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # 証明書設定は一時的に無効化
    
    - name: Build and sign
      env:
        # macOSコード署名を無効化（証明書未設定のため）
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: |
        npm run dist:mac-x64
        npm run dist:mac-arm64
    
    - name: Upload artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: mac-builds
        path: release/*.dmg

  build-win:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Setup Node.js
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: 24.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build and sign
      env:
        # Windowsコード署名を無効化（証明書未設定のため）
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: npm run dist:win
    
    - name: Upload artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: win-builds
        path: release/*.exe

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    
    - name: Download all artifacts
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        path: release-artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        files: release-artifacts/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}