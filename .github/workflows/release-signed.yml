name: Release (Code Signed)

on:
  # 無効化: タグpushでのトリガーを無効化
  # push:
  #   tags:
  #     - 'v*'
  workflow_dispatch:  # 手動実行のみ

permissions:
  contents: write

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
    
    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version: 24.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # 証明書設定は一時的に無効化
    
    - name: Build and sign
      env:
        # macOSコード署名を無効化（証明書未設定のため）
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: |
        npm run dist:mac-x64
        npm run dist:mac-arm64
    
    - name: Upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: mac-builds
        path: release/*.dmg

  build-win:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
    
    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
      with:
        node-version: 24.x
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build and sign
      env:
        # Windowsコード署名を無効化（証明書未設定のため）
        CSC_IDENTITY_AUTO_DISCOVERY: false
      run: npm run dist:win
    
    - name: Upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: win-builds
        path: release/*.exe

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
    
    - name: Download all artifacts
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
      with:
        path: release-artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
      with:
        files: release-artifacts/**/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}